name: CI â€“ Symfony 6.4 / PHPUnit 10 / Codacy coverage

on: [push, pull_request]

jobs:
  coverage:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: app_test
        ports: ['3306:3306']
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608 # v4.1.7

      - uses: shivammathur/setup-php@67d651e4196f7eaa0a8c42cc56f93588e1fbd05c # v2.29.0
        with:
          php-version: '8.2'
          extensions: xdebug
          coverage: xdebug

      - uses: ramsey/composer-install@6d3a448e9bf7a7dfb754bc7df03f0484e7958d5b # v3.0.0
        with:
          composer-options: --prefer-dist --no-interaction

      - name: Run PHPUnit with coverage
        env:
          DATABASE_URL: "mysql://root:root@127.0.0.1:3306/app_test?serverVersion=8.0&charset=utf8mb4"
          XDEBUG_MODE: coverage
        run: |
          php bin/console doctrine:database:create --env=test --if-not-exists
          php bin/console doctrine:schema:create  --env=test --no-interaction
          mkdir -p build/coverage
          vendor/bin/phpunit --testsuite unit,functional \
              --coverage-clover build/clover.xml \
              --coverage-html  build/coverage

      - name: Upload coverage to Codacy
        uses: codacy/codacy-coverage-reporter-action@a6ec055b57272cb3a9c7cc36d0c47c7e07e05c38 # v1.3.0
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: build/clover.xml
          branch: ${{ github.ref_name }}
          commit: ${{ github.sha }}
